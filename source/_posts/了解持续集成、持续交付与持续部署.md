---
title: 了解持续集成、持续交付与持续部署
date: 2017-03-27 17:09:28
tags:
categories:
description:
---

不管你是运维还是开发，都经常会听到持续集成，持续交付，持续部署几个概念。这三者究竟是什么，有何联系和区别呢？



![workflow](http://i4.buimg.com/588729/9d1a3ffc2b178f7c.png)


<!--more-->


## 持续与集成的概念

**集成**，外行人光听这个词可能并不知道指的是什么意思，其实很简单，通俗地讲就是合在一块。把代码commit到SVN或Git上是集成代码，编译代码是集成逻辑，测试是集成功能……就是把所有开发人员的部分集成在一起，使之成为一个可用的完整产品。**也就是开发过程中的编译、测试、打包**。

但是集成也不是简单的杂糅起来，集成过程中很可能会出错，出错了大家一起DEBUG就好了。

那么问题来了，**是所有功能都开发完再进行集成，还是每完成一个小功能就集成呢？**似乎最后的结果都是一样的呀。但在实际开发过程中，这两者的开发效率是天差地别的。如果是所有功能都完成再集成的话，一旦集成出错，就很难定位到问题所在；而如果是一个个小功能进行集成，出错的话就很容易定位问题所在。就好比铺地砖，正确的做法都是切割一块铺一块，如果是先全部切割好再铺的话，如果尺寸有误，那么返工的成本就很大了。

切割好一块铺一块，完成一个功能就进行一次集成，这就是**持续**的概念。不断的获取反馈，响应反馈。每完成一个完整的部分，就向下个环节交付，发现问题可以马上调整，使问题不会放大到其他部分和后面的环节。



## 开发生命周期
一般来说，一个产品的开发到上线的几个阶段如下：
>编码 --> 构建 --> 集成 --> 测试 --> 交付 --> 部署


持续集成、持续交付和持续部署也就是要把集成、交付、部署这三个环节自动化。一是为了节省人力，二是可以快速定位问题，大大提升了开发的效率。

如下图所示，「持续集成（Continuous Integration）」、「持续交付（Continuous Delivery）」和「持续部署（Continuous Deployment）」有着不同的软件自动化交付周期。

![lifecycle](http://i4.buimg.com/588729/a5bfdc951862afc8.png)


















## 持续集成

### 持续集成概念

持续集成是指软件**个人研发的部分向软件整体交付**(commit)，频繁进行集成以便更快地发现其中的错误。









![Continuous Integration](http://i4.buimg.com/588729/a592accc18e3db46.png)





持续集成强调开发人员**提交了新代码之后，立刻进行构建、（单元）测试**。根据测试结果，可以确定新代码和原有代码能否正确地集成在一起。如上图所示，通过BUILD和TEST，开发人员会迅速得到一个RESULT，如果返回的结果有错，就可以立即对错误进行处理。

### 如何持续集成

- 全面的**自动化测试**。这是实践持续集成&持续部署的基础。
- 灵活的基础设施。容器，虚拟机的存在让开发人员和 QA 人员不必再大费周折；
- **版本控制工具**。如 Git，CVS，SVN 等；
- 自动化的构建和软件发布流程的工具，如 Jenkins，flow.ci；
- 反馈机制。如构建/测试的失败，可以快速地反馈到相关负责人，以尽快解决。

### 持续集成的好处

- “快速失败”，在对产品没有风险的情况下进行测试，并快速响应；
- 最大限度地减少风险，降低修复错误代码的成本；
- 将重复性的手工流程自动化，让工程师更加专注于代码；
- 保持频繁部署，快速生成可部署的软件；
- 提高项目的能见度，方便团队成员了解项目的进度和成熟度；


## 持续交付

### 持续交付概念

持续交付在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的「类生产环境」中。


![Continuous Delivery](http://i4.buimg.com/588729/cdd193408a000097.png)














试想想，如果说等到所有东西都完成了才向下个环节交付，导致所有的问题只能再最后才爆发出来，解决成本巨大甚至无法解决。比如，我们完成单元测试后，可以把代码部署到连接数据库的 Staging 环境中进行更多的自动化测试。如果代码没有问题，可以继续手动部署到生产环境中。


### 持续交付的好处


- 快速发布。能够应对业务需求，并更快地实现软件价值。
- 编码->测试->上线->交付的频繁迭代周期缩短，同时获得迅速反馈；
- 高质量的软件发布标准。整个交付过程标准化、可重复、可靠，
- 整个交付过程进度可视化，方便团队人员了解项目成熟度；




## 持续部署

### 持续部署概念

持续部署则是在持续交付的基础上，把部署到生产环境的过程自动化。**当交付的代码通过评审之后，自动部署到生产环境中**。持续部署是持续交付的最高阶段。这意味着，所有通过了一系列的自动化测试的改动都将自动部署到生产环境。

![Continuous Deployment](http://i4.buimg.com/588729/46c5b5549a561740.png)














持续部署的目标是，代码在任何时刻都是可部署的，可以进入生产阶段。



## 整个流程

根据持续集成的设计，代码从提交到生产，整个过程有以下几步。

### 提交

流程的第一步，是开发者向代码仓库提交代码。所有后面的步骤都始于本地代码的一次提交（commit）。

### 测试（第一轮）

代码仓库对commit操作配置了钩子（hook），只要提交代码或者合并进主干，就会跑自动化测试。

测试有几种:
- 单元测试：针对函数或模块的测试
- 集成测试：针对整体产品的某个功能的测试，又称功能测试
- 端对端测试：从用户界面直达数据库的全链路测试

第一轮至少要跑单元测试。

### 构建

通过第一轮测试，代码就可以合并进主干，就算可以交付了。

交付后，就先进行构建（build），再进入第二轮测试。所谓构建，指的是将源码转换为可以运行的实际代码，比如安装依赖，配置各种资源（样式表、JS脚本、图片）等等。

常用的构建工具如下。
- Jenkins
- Travis
- Codeship
- Strider


### 测试（第二轮）

构建完成，就要进行第二轮测试。如果第一轮已经涵盖了所有测试内容，第二轮可以省略，当然，这时构建步骤也要移到第一轮测试前面。

第二轮是全面测试，单元测试和集成测试都会跑，有条件的话，也要做端对端测试。所有测试以自动化为主，少数无法自动化的测试用例，就要人工跑。

需要强调的是，新版本的每一个更新点都必须测试到。如果测试的覆盖率不高，进入后面的部署阶段后，很可能会出现严重的问题。

### 部署

通过了第二轮测试，当前代码就是一个可以直接部署的版本（artifact）。将这个版本的所有文件打包（ tar filename.tar * ）存档，发到生产服务器。

生产服务器将打包文件，解包成本地的一个目录，再将运行路径的符号链接（symlink）指向这个目录，然后重新启动应用。这方面的部署工具有Ansible，Chef，Puppet等。

### 回滚

一旦当前版本发生问题，就要回滚到上一个版本的构建结果。最简单的做法就是修改一下符号链接，指向上一个版本的目录。



---

>参考
>[持续集成是什么？ - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html)
>[谈谈持续集成，持续交付，持续部署之间的区别](http://blog.flow.ci/cicd_difference/)

